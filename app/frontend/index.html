<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title id="pageTitle">–ú–æ–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å</title>

<!-- –ì–ê–†–î: –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ ‚Äî –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞ -->
<script>
  if (!localStorage.getItem('pf_token')) {
    window.location.replace('login.html');
  }
</script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/axios@1.7.2/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

<style>
  /* === –¢–ï–ú–ê === */
  :root[data-theme='light']{
    --bg:#0f1020; --bg2:#15172b; /* –¥–µ–ª–∞–µ–º —Ç–µ–º–Ω–µ–µ —Ñ–æ–Ω ‚Äî –≤—ã–≥–ª—è–¥–∏—Ç –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
    --card:#1b1e39; --stroke:rgba(255,255,255,.10);
    --text:#ecf0ff; --muted:#a0a7c9; --brand:#6a7dff; --brand2:#7ff0ff;
    --accent:#f86aa4; --ok:#26d3a9; --warn:#ffd166;
    --shadow:0 10px 30px rgba(0,0,0,.35); --shadow-lg:0 20px 60px rgba(0,0,0,.45);
    --ring:0 0 0 3px rgba(122,162,255,.28);
    --input-bg:#1b2146; --input-bg-hover:#202759;
    --menu-bg:#151935; --menu-text:#ecf0ff;
    color-scheme: dark;
  }
  :root[data-theme='dark']{ /* –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –æ–±–µ —Ç–µ–º—ã —Ç—ë–º–Ω—ã–µ, –Ω–æ –æ—Å—Ç–∞–≤–∏–ª –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å */
    --bg:#0f1020; --bg2:#15172b; --card:#1b1e39; --stroke:rgba(255,255,255,.10);
    --text:#ecf0ff; --muted:#a0a7c9; --brand:#6a7dff; --brand2:#7ff0ff;
    --accent:#f86aa4; --ok:#26d3a9; --warn:#ffd166;
    --shadow:0 10px 30px rgba(0,0,0,.35); --shadow-lg:0 20px 60px rgba(0,0,0,.45);
    --ring:0 0 0 3px rgba(122,162,255,.28);
    --input-bg:#1b2146; --input-bg-hover:#202759;
    --menu-bg:#151935; --menu-text:#ecf0ff;
    color-scheme: dark;
  }

  *{box-sizing:border-box}
  html,body{scroll-behavior:smooth}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--text);
    background:
      radial-gradient(900px 600px at 120% 10%, rgba(122,162,255,.13), transparent),
      radial-gradient(1400px 700px at -20% -10%, rgba(247,37,133,.14), transparent),
      linear-gradient(180deg, var(--bg), var(--bg2));
    min-height:100vh; transition: background .35s ease, color .2s ease;
  }
  .container{max-width:1180px; margin:0 auto; padding:18px 16px}

  header{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:12px}
  .title-wrap{display:flex; gap:8px; align-items:center}
  h1{margin:0; font-weight:800; letter-spacing:-.3px; font-size:22px}
  .title-edit{cursor:pointer; border:1px solid var(--stroke); background:var(--card); border-radius:10px; padding:6px 10px; font-weight:700}

  .header-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .btn{
    position:relative; overflow:hidden; padding:8px 12px; border-radius:12px; border:1px solid var(--stroke);
    background:var(--card); color:var(--text); cursor:pointer; font-weight:800; font-size:13px;
    box-shadow:var(--shadow); transition:transform .18s ease, box-shadow .22s ease, background .2s ease
  }
  .btn:hover{transform:translateY(-1px); box-shadow:var(--shadow-lg)}
  .btn:focus{outline:none; box-shadow:var(--shadow), var(--ring)}
  .btn-primary{background:linear-gradient(135deg, var(--brand), var(--brand2)); color:#0c0f21; border:1px solid transparent}
  .btn-danger{background:var(--accent); color:#fff; border:none}
  .btn::after{content:""; position:absolute; inset:0; background:radial-gradient(140px 140px at var(--rx,50%) var(--ry,50%), rgba(255,255,255,.45), transparent 60%); opacity:0; transition:opacity .6s ease}
  .btn.rippling::after{opacity:.8; transition:none}

  /* --- –ö–∞—Ä—Ç—ã/–≥—Ä–∞—Ñ–∏–∫–∏ --- */
  .cards{display:grid; grid-template-columns:repeat(12,1fr); gap:10px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid var(--stroke); border-radius:14px; padding:12px; box-shadow:var(--shadow)}
  .card h3{margin:0 0 8px; color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.2px}
  .card-sm{padding:10px}
  .span-4{grid-column:span 4}
  .span-12{grid-column:span 12}

  /* --- –°–≤–æ–¥–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–∫–æ–º–ø–∞–∫—Ç) --- */
  .summary{display:grid; grid-template-columns:repeat(12,1fr); gap:10px; margin:10px 0 14px}
  .summary-card{position:relative; overflow:hidden; border:1px solid var(--stroke); border-radius:14px; padding:12px; background:var(--card); box-shadow:var(--shadow); cursor:default}
  .summary-card .k{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.3px}
  .summary-card .v{font-size:18px; font-weight:900; line-height:1.1; margin-top:4px}
  .summary-card.hoverable{cursor:pointer}
  .summary-card[data-kind="total"]{grid-column:span 6}
  .summary-card:not([data-kind="total"]){grid-column:span 2}

  /* --- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω —Å–µ–∫—Ü–∏–π --- */
  .accordion{display:flex; flex-direction:column; gap:10px}
  .collapsible{border:1px solid var(--stroke); border-radius:14px; background:var(--card); overflow:hidden}
  .collapsible-header{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px 14px; cursor:pointer; user-select:none}
  .collapsible-title{display:flex; align-items:center; gap:8px; font-weight:800}
  .collapsible-badge{font-weight:900; color:var(--muted)}
  .chev{transition:transform .25s ease; opacity:.85}
  .collapsible[aria-expanded="true"] .chev{transform:rotate(180deg)}
  .collapse-content{max-height:0; opacity:.0; padding:0 12px; transition:max-height .30s ease, opacity .25s ease, padding .20s ease}
  .collapsible[aria-expanded="true"] .collapse-content{max-height:1600px; opacity:1; padding:0 12px 12px}

  /* --- –≠–ª–µ–º–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–æ–≤ --- */
  .assets-list{display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px}
  .asset{border:1px dashed var(--stroke); border-radius:12px; padding:10px; background:rgba(255,255,255,.04)}
  .asset-h{display:flex; justify-content:space-between; align-items:center; gap:8px}
  .asset-name{font-weight:800}
  .asset-d{color:var(--muted); font-size:12px; margin-top:6px; display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
  .asset-actions{display:flex; gap:6px; flex-wrap:wrap}

  /* --- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è --- */
  .form-grid{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
  .form-group{display:flex; flex-direction:column; gap:6px}
  label{font-size:11px; color:var(--muted); font-weight:700}
  select,input{appearance:none; background:var(--input-bg); border:1px solid var(--stroke); color:var(--text); border-radius:12px; padding:10px 12px; font-weight:700; width:100%}
  select:hover,input:hover{background:var(--input-bg-hover)}
  .form-actions{display:flex; justify-content:flex-end; gap:8px; margin-top:10px}

  /* --- –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ (hover/tap) --- */
  .tip{position:fixed; z-index:3000; background:var(--card); border:1px solid var(--stroke); box-shadow:var(--shadow-lg); border-radius:12px; padding:10px 12px; max-width:260px; font-size:12px; line-height:1.35; pointer-events:none; transform:translate(-50%,-100%); opacity:0; transition:opacity .15s ease}
  .tip.show{opacity:1}
  .tip .h{font-weight:900; margin-bottom:4px; color:var(--muted); text-transform:uppercase; font-size:11px}
  .tip .row{display:flex; justify-content:space-between; gap:8px}
  .tip .muted{color:var(--muted)}

  /* --- –°–∫–µ–ª–µ—Ç --- */
  .skeleton{position:relative; overflow:hidden; background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.14), rgba(255,255,255,.06)); background-size:200% 100%; animation:shine 1.2s linear infinite}
  @keyframes shine{0%{background-position:200% 0} 100%{background-position:-200% 0}}

  /* --- –ê–¥–∞–ø—Ç–∏–≤ --- */
  @media (max-width: 1100px){
    .summary-card[data-kind="total"]{grid-column:span 12}
    .summary-card:not([data-kind="total"]){grid-column:span 4}
    .span-4{grid-column:span 12}
  }
  @media (max-width: 720px){
    header{flex-direction:column; align-items:flex-start}
    .btn{padding:7px 10px; font-size:12px}
    .asset-d{grid-template-columns:1fr 1fr}
    .form-grid{grid-template-columns:1fr 1fr}
    .summary{grid-template-columns:repeat(6,1fr)}
    .summary-card:not([data-kind="total"]){grid-column:span 3}
  }
  @media (max-width: 420px){
    .asset-d{grid-template-columns:1fr}
    .form-grid{grid-template-columns:1fr}
  }

  .auth-status{font-weight:800; color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="title-wrap">
      <h1 id="portfolioTitle">‚ú® –ú–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å</h1>
      <button id="editTitleBtn" class="title-edit" title="–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ">‚úèÔ∏è</button>
    </div>
    <div class="header-actions">
      <div id="authStatus" class="auth-status">–ì–æ—Å—Ç—å</div>
      <button id="logoutBtn" class="btn btn-danger" title="–í—ã–π—Ç–∏">üö™ –í—ã–π—Ç–∏</button>
      <button id="refreshBtn" class="btn" title="–û–±–Ω–æ–≤–∏—Ç—å –∫–æ—Ç–∏—Ä–æ–≤–∫–∏">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      <button id="themeToggle" class="btn" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåì –¢–µ–º–∞</button>
    </div>
  </header>

  <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
  <div class="cards">
    <div class="card span-4" id="sk1"><h3>–ê–ª–ª–æ–∫–∞—Ü–∏—è –ø–æ –∫–ª–∞—Å—Å–∞–º</h3><canvas id="chartByClass" style="width:100%; height:280px"></canvas></div>
    <div class="card span-4" id="sk2"><h3>–ê–ª–ª–æ–∫–∞—Ü–∏—è –ø–æ —Ç–∏–∫–µ—Ä–∞–º (—Å—Ç–æ–∏–º–æ—Å—Ç—å)</h3><canvas id="chartByTickerValue" style="width:100%; height:280px"></canvas></div>
    <div class="card span-4" id="sk3"><h3>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—É–º–∞–≥ –ø–æ —Ç–∏–∫–µ—Ä–∞–º</h3><canvas id="chartByTickerQty" style="width:100%; height:280px"></canvas></div>
  </div>

  <!-- –°–≤–æ–¥–Ω—ã–µ -->
  <div class="summary" id="portfolioSummary"></div>

  <!-- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω —Å–µ–∫—Ü–∏–π -->
  <div class="accordion" id="portfolioSections"></div>

  <!-- –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤ -->
  <div class="collapsible" aria-expanded="true" id="sec-add">
    <div class="collapsible-header" data-toggle="#sec-add">
      <div class="collapsible-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤</div>
      <div class="chev">‚ñæ</div>
    </div>
    <div class="collapse-content">
      <form id="assetForm" class="card-sm">
        <div class="form-grid">
          <div class="form-group">
            <label for="assetType">–¢–∏–ø –∞–∫—Ç–∏–≤–∞</label>
            <select id="assetType" required>
              <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ</option>
              <option value="stock">–ê–∫—Ü–∏—è</option>
              <option value="bond">–û–§–ó/–û–±–ª–∏–≥–∞—Ü–∏—è</option>
              <option value="fund">–§–æ–Ω–¥/ETF</option>
              <option value="savings">–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á—ë—Ç</option>
            </select>
          </div>
          <div class="form-group" id="fieldName">
            <label for="assetName">–¢–∏–∫–µ—Ä / –ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" id="assetName" placeholder="SBER, YNDX, TGLD" />
          </div>
          <div class="form-group" id="fieldQuantity">
            <label for="assetQuantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
            <input type="number" id="assetQuantity" min="0" step="1" placeholder="–ù–∞–ø—Ä.: 10" />
          </div>
          <div class="form-group" id="fieldPrice">
            <label for="assetAvgPrice">–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ (‚ÇΩ)</label>
            <input type="number" id="assetAvgPrice" step="0.0001" min="0" placeholder="–ù–∞–ø—Ä.: 4383" />
          </div>
          <div class="form-group" id="fieldSavingsAmount" style="display:none;">
            <label for="savingsAmount">–°—É–º–º–∞ (‚ÇΩ)</label>
            <input type="number" id="savingsAmount" min="0" step="0.01" placeholder="–ù–∞–ø—Ä.: 100000" />
          </div>
          <div class="form-group" id="fieldDate">
            <label for="assetDate">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏/–≤–Ω–µ—Å–µ–Ω–∏—è</label>
            <input type="text" id="assetDate" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥" />
          </div>
        </div>
        <div class="form-actions">
          <button type="reset" class="btn" id="resetBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button type="submit" class="btn btn-primary" id="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Tooltip container -->
<div id="tooltip" class="tip" role="tooltip" aria-hidden="true"></div>

<script>
  /* ====== CONFIG ====== */
  const BACKEND =
    (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? 'http://127.0.0.1:8000'
      : '/api';  // –ø—Ä–æ–¥–∞–∫—à–Ω ‚Äî —á–µ—Ä–µ–∑ nginx

  Chart.defaults.font.family = 'Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  Chart.defaults.responsive = true;

  /* ====== STATE ====== */
  let auth = { token:null, userId:null, email:null, portfolioId:null };
  let portfolio = { savings:[], stocks:[], bonds:[], funds:[], history:[] };
  const charts = {};
  let fp;
  let quotesTimer = null;
  let isAnyChartOpen = false;
  let isRefreshing = false;

  /* ====== HELPERS ====== */
  const nf0 = new Intl.NumberFormat('ru-RU',{ maximumFractionDigits:0 });
  const nf2 = new Intl.NumberFormat('ru-RU',{ maximumFractionDigits:2 });
  const fmt = (n,d=2)=> isFinite(n) ? (d===0? nf0.format(n) : nf2.format(n)) : '0';
  const cssId = s => (s||'').toString().replace(/[^a-z0-9]/gi,'_');
  const qS = (sel,root=document)=>root.querySelector(sel);
  const qSA = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

  function totalValue(){ return ['savings','stocks','bonds','funds'].reduce((s,k)=> s + (portfolio[k]||[]).reduce((a,i)=>a+(i.value||0),0), 0); }
  function pushHistory(){ portfolio.history.push({ t: Date.now(), total: totalValue() }); if(portfolio.history.length>600) portfolio.history.shift(); saveLocal(); }
  function fmtISOtoRU(iso){ if(!iso) return '‚Äî'; const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(iso); if(!m) return iso; return `${m[3]}.${m[2]}.${m[1]}`; }
  function toISOFromAlt(inputVal){ const m=/^(\d{2})\.(\d{2})\.(\d{4})$/.exec((inputVal||'').trim()); if(!m) return null; return `${m[3]}-${m[2]}-${m[1]}`; }
  function displayLabel(it){ if (it.displayName) return it.displayName; if (it.name && it.ticker) return `${it.name} (${it.ticker})`; return it.name || it.ticker || ''; }

  function totalPL(){
    const cats = ['stocks','bonds','funds'];
    let abs=0, base=0;
    for(const c of cats){
      for(const it of (portfolio[c]||[])){
        const cp = it.currentPrice ?? it.avgPrice ?? 0;
        const qty = it.quantity||0;
        const avg = it.avgPrice||0;
        const nowVal = cp*qty;
        const cost = avg*qty;
        abs += (avg>0 ? (nowVal - cost) : 0);
        base += cost;
      }
    }
    const pct = base>0 ? abs/base*100 : 0;
    return {abs, pct};
  }

  /* ====== TOAST ====== */
  function toast(msg, type='ok'){
    const id='__toasts'; let wrap=qS('#'+id);
    if(!wrap){ wrap=document.createElement('div'); wrap.id=id; wrap.style.cssText='position:fixed;bottom:16px;right:16px;display:flex;flex-direction:column;gap:10px;z-index:4000'; document.body.appendChild(wrap); }
    const el=document.createElement('div');
    el.style.cssText='min-width:220px;max-width:320px;padding:12px 14px;border-radius:12px;background:var(--card);border:1px solid var(--stroke);box-shadow:var(--shadow);display:flex;gap:8px;align-items:flex-start;animation:slideIn .35s ease both';
    el.innerHTML=`<div style="font-weight:800;${type==='err'?'color:var(--accent)':''}">${msg}</div>`;
    wrap.appendChild(el);
    setTimeout(()=>{ el.style.opacity=.0; el.style.transform='translateY(6px)'; }, 2400);
    setTimeout(()=>{ el.remove(); }, 2800);
  }

  /* ====== LOCALSTORAGE ====== */
  function saveLocal(){ try{ localStorage.setItem('pf_data', JSON.stringify(portfolio)); }catch(_){} }
  function loadLocal(){ try{ const j = localStorage.getItem('pf_data'); if(j) portfolio = JSON.parse(j); }catch(_){} }
  function saveAuth(){
    localStorage.setItem('pf_token', auth.token||''); localStorage.setItem('pf_user_id', auth.userId||'');
    localStorage.setItem('pf_email', auth.email||''); localStorage.setItem('pf_portfolio_id', auth.portfolioId||''); applyAuthUi();
  }
  function loadAuth(){
    auth.token = localStorage.getItem('pf_token') || null;
    auth.userId = Number(localStorage.getItem('pf_user_id') || '') || null;
    auth.email = localStorage.getItem('pf_email') || null;
    auth.portfolioId = Number(localStorage.getItem('pf_portfolio_id') || '') || null;
    applyAuthUi();
  }
  function clearAuth(){ auth = { token:null, userId:null, email:null, portfolioId:null }; saveAuth(); }

  /* ====== UI BASICS ====== */
  function applyTitle(t){ qS('#portfolioTitle').textContent = t || '‚ú® –ú–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å'; qS('#pageTitle').textContent = (t || '–ú–æ–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å'); }
  function loadTitle(){ const t = localStorage.getItem('pf_title') || '‚ú® –ú–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å'; applyTitle(t); }
  function applyAuthUi(){ const st=qS('#authStatus'); const btnOut=qS('#logoutBtn'); if(auth.token && auth.email){ st.textContent=`–ü—Ä–∏–≤–µ—Ç, ${auth.email}`; btnOut.style.display=''; }else{ st.textContent='–ì–æ—Å—Ç—å'; btnOut.style.display='none'; } }
  function setTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem('pf_theme', t); renderCharts(); }
  function initTheme(){ setTheme(localStorage.getItem('pf_theme') || 'dark'); }
  function initDatePicker(){ if(fp) fp.destroy(); fp = flatpickr('#assetDate',{ locale: flatpickr.l10ns.ru, dateFormat: 'Y-m-d', altInput: true, altFormat: 'd.m.Y', allowInput: true, defaultDate: new Date() }); }

  /* ====== AXIOS ====== */
  const api = axios.create({ baseURL: BACKEND, timeout: 20000 });
  api.interceptors.request.use(cfg=>{ if(auth.token){ cfg.headers = cfg.headers || {}; cfg.headers['Authorization'] = `Bearer ${auth.token}`; } return cfg; });

  /* ====== API ====== */
  async function apiListPortfolios(){ const {data} = await api.get('/portfolio'); return data||[]; }
  async function apiCreatePortfolio(){ const {data} = await api.post('/portfolio', { title:'–û—Å–Ω–æ–≤–Ω–æ–π', type:'broker', currency:'RUB' }); return data; }
  async function apiListPositionsFull(pfId){ const {data} = await api.get(`/portfolio/${pfId}/positions/full`); return data||[]; }
  async function apiDeletePosition(positionId){ await api.delete(`/portfolio/positions/${positionId}`); }
  async function apiUpsertPositionByFigi({ portfolio_id, figi, ticker, class_hint, qty, avg, name, currency, nominal }){
    const payload={ portfolio_id, figi, ticker:(ticker||'').toUpperCase(), class_hint:class_hint||null, quantity:Number(qty)||0, avg_price:Number(avg)||0, name:name||null, currency:currency||null, nominal:nominal??null };
    const {data}=await api.post('/portfolio/positions', payload); return data;
  }
  async function apiResolve(ticker, classHint=null){ const {data}=await api.get('/resolve',{ params:{ ticker } }); const hit=(data?.results&&data.results[0])?data.results[0]:null; if(!hit) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω FIGI –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–∫–µ—Ä–∞'); return hit; }
  async function apiResolveQuoteByTicker(ticker, classHint=null){ const r=await apiResolve(ticker, classHint); const {data:q}=await api.get(`/quote/${r.figi}`); return {...r,...q}; }
  async function apiBatchQuotes(tickers, classHint=null){ const payload={tickers}; if(classHint) payload.class_hint=classHint; const {data}=await api.post('/quotes_by_tickers', payload); return data.results||[]; }
  async function apiCandles(figi, interval='1d', fromISO=null, toISO=null){
    try{ const params={interval}; if(fromISO) params.from_=fromISO; if(toISO) params.to=toISO; const {data}=await api.get(`/candles/${figi}`,{params}); return data; }
    catch(err){ console.warn('candles error', err); toast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞', 'err'); return []; }
  }

  /* ====== LOAD DB ====== */
  async function loadFromDB(){
    let pfs=await apiListPortfolios(); if(!pfs.length){ const created=await apiCreatePortfolio(); pfs=[created]; }
    const pf=pfs[0]; auth.portfolioId=pf.id; saveAuth();
    const rows=await apiListPositionsFull(pf.id);
    const hist=portfolio.history||[]; portfolio={ savings:[], stocks:[], bonds:[], funds:[], history:hist };
    for(const pos of rows){
      const inst=pos.instrument||{}; const cls=inst.class||'share';
      const bucket=(cls==='share')?'stocks':(cls==='bond'?'bonds':(cls==='etf'?'funds':'stocks'));
      const ticker=(inst.ticker||'').toUpperCase(); const avg=Number(pos.avg_price)||0; const qty=Number(pos.quantity)||0;
      portfolio[bucket].push({
        posId:pos.id, figi:pos.figi, name:ticker||pos.figi, ticker, class:cls, currency:inst.currency||null, nominal:inst.nominal??null,
        displayName:(inst.name&&ticker)?`${inst.name} (${ticker})`:(inst.name||ticker||pos.figi),
        quantity:qty, avgPrice:avg, currentPrice:null, value:avg*qty, pnlAbs:0, pnlPct:0, date:null
      });
    }
  }

  /* ====== SUMMARY RENDER + TIPS ====== */
  function buildBreakdown(){
    const vS=(portfolio.stocks||[]).reduce((s,i)=>s+((i.currentPrice??i.avgPrice??0)*(i.quantity||0)),0);
    const vB=(portfolio.bonds||[]).reduce((s,i)=>s+((i.currentPrice??i.avgPrice??0)*(i.quantity||0)),0);
    const vF=(portfolio.funds||[]).reduce((s,i)=>s+((i.currentPrice??i.avgPrice??0)*(i.quantity||0)),0);
    const vSv=(portfolio.savings||[]).reduce((s,i)=>s+i.value,0);
    const sum=vS+vB+vF+vSv || 1;
    return {
      total:sum,
      parts:[
        {k:'–ù–∞–∫–æ–ø–∏—Ç.', v:vSv, p:vSv/sum*100},
        {k:'–ê–∫—Ü–∏–∏', v:vS, p:vS/sum*100},
        {k:'–û–§–ó', v:vB, p:vB/sum*100},
        {k:'–§–æ–Ω–¥—ã', v:vF, p:vF/sum*100},
      ]
    };
  }

  function sectionTipText(kind){
    const map = { stocks:'–ê–∫—Ü–∏–∏', bonds:'–û–§–ó', funds:'–§–æ–Ω–¥—ã' };
    if(kind==='total'){
      const br=buildBreakdown();
      const lines = br.parts.map(x=>`<div class="row"><span>${x.k}</span><b>${fmt(x.v)} ‚ÇΩ</b></div><div class="muted">${fmt(x.p)}%</div>`).join('');
      return `<div class="h">–°–æ—Å—Ç–∞–≤ –ø–æ—Ä—Ç—Ñ–µ–ª—è</div>${lines}`;
    }
    const arr = portfolio[kind]||[];
    if(!arr.length) return `<div class="h">${map[kind]}</div><div class="muted">–ü—É—Å—Ç–æ</div>`;
    const totalVal = arr.reduce((s,i)=>s+((i.currentPrice??i.avgPrice??0)*(i.quantity||0)),0) || 1;
    const top = arr
      .map(i=>({ label: displayLabel(i)||i.name, val:(i.currentPrice??i.avgPrice??0)*(i.quantity||0) }))
      .sort((a,b)=>b.val-a.val)
      .slice(0,6);
    const lines = top.map(x=>`<div class="row"><span>${x.label}</span><b>${fmt(x.val)} ‚ÇΩ</b></div><div class="muted">${fmt(x.val/totalVal*100)}%</div>`).join('');
    const more = arr.length>6 ? `<div class="muted">–∏ –µ—â—ë ${arr.length-6}‚Ä¶</div>` : '';
    return `<div class="h">${map[kind]}</div>${lines}${more}`;
  }

  function attachSummaryTips(){
    const tip = qS('#tooltip');
    function showTip(html, x, y){
      tip.innerHTML = html; tip.style.left = `${x}px`; tip.style.top = `${y-12}px`; tip.classList.add('show'); tip.setAttribute('aria-hidden','false');
    }
    function hideTip(){ tip.classList.remove('show'); tip.setAttribute('aria-hidden','true'); }

    // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ ‚Äî hover, –Ω–∞ –º–æ–±–∏–ª–∫–µ ‚Äî tap
    const isTouch = matchMedia('(pointer: coarse)').matches;

    qSA('.summary-card.hoverable').forEach(card=>{
      const kind = card.dataset.kind;
      const handlerMove = (e)=> showTip(sectionTipText(kind), e.clientX, e.clientY);
      const handlerLeave = ()=> hideTip();
      const handlerTap = (e)=>{
        if(tip.classList.contains('show') && tip.dataset.kind===kind){ hideTip(); tip.dataset.kind=''; return; }
        tip.dataset.kind=kind; showTip(sectionTipText(kind), e.clientX|| (card.getBoundingClientRect().left + card.offsetWidth/2), (e.clientY||card.getBoundingClientRect().top));
      };

      card.removeEventListener('mousemove', handlerMove);
      card.removeEventListener('mouseleave', handlerLeave);
      card.removeEventListener('click', handlerTap);

      if(isTouch){ card.addEventListener('click', handlerTap); }
      else { card.addEventListener('mousemove', handlerMove); card.addEventListener('mouseleave', handlerLeave); }
    });

    if(isTouch){ document.addEventListener('click', (e)=>{ if(!e.target.closest('.summary-card')){ tip.classList.remove('show'); } }); }
  }

  function renderSummary(){
    const vTotal = totalValue();
    const blocks = [
      { key:'total', title:'–í—Å–µ–≥–æ', val: vTotal, hover:true, wide:true },
      { key:'savings', title:'–ù–∞–∫–æ–ø–∏—Ç. —Å—á—ë—Ç', val: (portfolio.savings||[]).reduce((s,i)=>s+i.value,0), hover:false },
      { key:'stocks', title:'–ê–∫—Ü–∏–∏', val: (portfolio.stocks||[]).reduce((s,i)=>s+((i.currentPrice??i.avgPrice??0)*(i.quantity||0)),0), hover:true },
      { key:'bonds', title:'–û–§–ó', val: (portfolio.bonds||[]).reduce((s,i)=>s+((i.currentPrice??i.avgPrice??0)*(i.quantity||0)),0), hover:true },
      { key:'funds', title:'–§–æ–Ω–¥—ã', val: (portfolio.funds||[]).reduce((s,i)=>s+((i.currentPrice??i.avgPrice??0)*(i.quantity||0)),0), hover:true },
    ];
    const wrap = qS('#portfolioSummary');
    wrap.innerHTML = blocks.map(b=>`
      <div class="summary-card ${b.hover?'hoverable':''}" data-kind="${b.key}">
        <div class="k">${b.title}</div>
        <div class="v">${fmt(b.val)} ‚ÇΩ</div>
      </div>`).join('');
    attachSummaryTips();

    // –∫–ª–∏–∫ –ø–æ –º–∏–Ω–∏-–∫–∞—Ä—Ç–æ—á–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å–µ–∫—Ü–∏—é (–∞–∫–∫–æ—Ä–¥–µ–æ–Ω)
    qSA('.summary-card').forEach(el=>{
      el.addEventListener('click', ()=>{
        const m = {stocks:'#sec-stocks', bonds:'#sec-bonds', funds:'#sec-funds', savings:'#sec-savings'};
        if(m[el.dataset.kind]) toggleCollapsible(m[el.dataset.kind], true);
      });
    });
  }

  /* ====== SECTIONS (–ê–ö–ö–û–†–î–ï–û–ù) ====== */
  function renderSections(){
    const wrap = qS('#portfolioSections'); wrap.innerHTML = '';

    const groups = [
      ['stocks','–ê–∫—Ü–∏–∏'],
      ['bonds','–û–§–ó/–û–±–ª–∏–≥–∞—Ü–∏–∏'],
      ['funds','–§–æ–Ω–¥—ã/ETF'],
      ['savings','–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á—ë—Ç']
    ];

    for(const [cat,label] of groups){
      const items = portfolio[cat]||[];
      const total = cat==='savings'
        ? items.reduce((s,i)=>s+i.value,0)
        : items.reduce((s,i)=>s+((i.currentPrice??i.avgPrice??0)*(i.quantity||0)),0);

      const secId = `sec-${cat}`;
      const header = `
        <div class="collapsible" id="${secId}" aria-expanded="false">
          <div class="collapsible-header" data-toggle="#${secId}">
            <div class="collapsible-title">${label}</div>
            <div class="collapsible-badge">${fmt(total)} ‚ÇΩ</div>
            <div class="chev">‚ñæ</div>
          </div>
          <div class="collapse-content">
            <div class="assets-list">
              ${items.map((it,idx)=>{
                if(cat==='savings'){
                  return `
                  <div class="asset">
                    <div class="asset-h">
                      <div class="asset-name">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
                      <div class="asset-actions">
                        <button class="btn btn-danger" data-action="del" data-type="${cat}" data-index="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
                      </div>
                    </div>
                    <div class="asset-d" style="grid-template-columns:repeat(2,1fr)">
                      <div>–°—É–º–º–∞: <b>${fmt(it.value)} ‚ÇΩ</b></div>
                      <div>–î–∞—Ç–∞: <b>${fmtISOtoRU(it.date)}</b></div>
                    </div>
                  </div>`;
                }
                const id = cssId(it.name);
                const curPrice = it.currentPrice ?? it.avgPrice ?? 0;
                const curVal = curPrice * (it.quantity||0);
                const pnlAbs = it.avgPrice ? (curPrice - it.avgPrice) * it.quantity : 0;
                const pnlPct = it.avgPrice ? ((curPrice - it.avgPrice)/it.avgPrice*100) : 0;
                const pnlColor = pnlAbs >= 0 ? 'color:var(--ok)' : 'color:var(--accent)';
                const title = displayLabel(it) || it.name;
                return `
                <div class="asset">
                  <div class="asset-h">
                    <div class="asset-name">${title} ${it.figi?`<small style="color:var(--muted)">(${it.figi})</small>`:''}</div>
                    <div class="asset-actions">
                      <button class="btn" data-action="show" data-name="${it.name}" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫">üìà –ì—Ä–∞—Ñ–∏–∫</button>
                      <button class="btn" data-action="edit" data-type="${cat}" data-index="${idx}">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                      <button class="btn btn-danger" data-action="del" data-type="${cat}" data-index="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                  </div>
                  <div class="asset-d">
                    <div>–ö–æ–ª-–≤–æ: <b>${fmt(it.quantity,0)}</b></div>
                    <div>–¶–µ–Ω–∞ —Å—Ä.: <b>${fmt(it.avgPrice)} ‚ÇΩ</b></div>
                    <div>–¢–µ–∫. —Ü–µ–Ω–∞: <b>${fmt(curPrice)} ‚ÇΩ</b></div>
                    <div>–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏: <b>${fmtISOtoRU(it.date)}</b></div>
                    <div>–°—Ç–æ–∏–º–æ—Å—Ç—å: <b>${fmt(curVal)} ‚ÇΩ</b></div>
                    <div style="${pnlColor}">P/L: <b>${fmt(pnlAbs)} ‚ÇΩ</b> (${fmt(pnlPct)}%)</div>
                  </div>
                  <div class="card-sm" id="box-${id}" style="display:none; margin-top:8px">
                    <div style="display:flex;gap:6px;flex-wrap:wrap;margin:6px 0">
                      <button class="btn btn-ghost chart-tab" data-action="period" data-period="1D" data-for="${id}">–î–µ–Ω—å</button>
                      <button class="btn btn-ghost chart-tab" data-action="period" data-period="1W" data-for="${id}">–ù–µ–¥–µ–ª—è</button>
                      <button class="btn btn-ghost chart-tab" data-action="period" data-period="1M" data-for="${id}">–ú–µ—Å—è—Ü</button>
                      <button class="btn btn-ghost chart-tab" data-action="period" data-period="1Y" data-for="${id}">–ì–æ–¥</button>
                    </div>
                    <canvas id="canvas-${id}" style="width:100%;height:260px"></canvas>
                  </div>
                </div>`;
              }).join('')}
            </div>
          </div>
        </div>`;
      wrap.insertAdjacentHTML('beforeend', header);
    });

    // –Ω–∞–≤–µ—Å–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è
    qSA('.collapsible-header').forEach(h=>{
      h.addEventListener('click', ()=> toggleCollapsible(h.dataset.toggle, true));
    });

    // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –Ω–∞ –º–æ–±–∏–ª–µ –≤—Å—ë –∑–∞–∫—Ä—ã—Ç–æ, –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –æ—Ç–∫—Ä–æ–µ–º –ø–µ—Ä–≤—É—é –Ω–µ–ø—É—Å—Ç—É—é —Å–µ–∫—Ü–∏—é
    const isMobile = matchMedia('(max-width: 900px)').matches;
    if(!isMobile){
      const firstNonEmpty = ['#sec-stocks','#sec-bonds','#sec-funds','#sec-savings'].find(sel=>{
        const id = sel.replace('#sec-',''); const cat = id; const arr = portfolio[cat]||[];
        return arr.length>0;
      });
      if(firstNonEmpty) toggleCollapsible(firstNonEmpty, false, true);
    }
  }

  function toggleCollapsible(selector, scrollInto=false, forceOpen=false){
    const el = qS(selector); if(!el) return;
    const wantOpen = forceOpen || el.getAttribute('aria-expanded')!=='true';
    // –∞–∫–∫–æ—Ä–¥–µ–æ–Ω ‚Äî –∑–∞–∫—Ä—ã—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ
    qSA('.collapsible').forEach(x=>{ if(x!==el){ x.setAttribute('aria-expanded','false'); } });
    el.setAttribute('aria-expanded', wantOpen ? 'true' : 'false');
    if(scrollInto && wantOpen){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
  }

  /* ====== CHARTS ====== */
  function grad(ctx, c1, c2){ const g = ctx.createLinearGradient(0,0,0,220); g.addColorStop(0,c1); g.addColorStop(1,c2); return g; }
  function removeSkeleton(){ ['sk1','sk2','sk3'].forEach(id=>{ const el=qS('#'+id); if(el) el.classList.remove('skeleton'); }); }

  const donutCenter = (getTextFn) => ({
    id: 'donutCenter',
    beforeDraw(chart) {
      const meta = chart.getDatasetMeta(0); if (!meta || !meta.data || !meta.data.length) return;
      const arc = meta.data[0]; const { x, y } = arc; const innerR = arc.innerRadius; const outerR = arc.outerRadius;
      const ctx = chart.ctx; const info = getTextFn(chart);
      ctx.save();
      ctx.beginPath(); ctx.arc(x, y, (innerR + outerR) / 2 * 0.70, 0, Math.PI * 2);
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card') || '#fff'; ctx.fill();
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#666'; ctx.font = '700 11px Inter';
      if (info.title) ctx.fillText(info.title, x, y - 18);
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text') || '#111'; ctx.font='800 16px Inter';
      if (info.line1) ctx.fillText(info.line1, x, y + 2);
      if (info.line2) { ctx.fillStyle = info.line2Color || (getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#666'); ctx.font='800 11px Inter'; ctx.fillText(info.line2, x, y + 20);}
      ctx.restore();
    }
  });

  function renderCharts(){
    const axisGrid = 'rgba(255,255,255,.10)';

    // Doughnut
    const classValues = [
      (portfolio.savings||[]).reduce((s,i)=>s+i.value,0),
      (portfolio.stocks||[]).reduce((s,i)=>s+((i.currentPrice??i.avgPrice??0)*(i.quantity||0)),0),
      (portfolio.bonds||[]).reduce((s,i)=>s+((i.currentPrice??i.avgPrice??0)*(i.quantity||0)),0),
      (portfolio.funds||[]).reduce((s,i)=>s+((i.currentPrice??i.avgPrice??0)*(i.quantity||0)),0)
    ];
    const total = classValues.reduce((a,b)=>a+b,0);
    const classLabels = ['–ù–∞–∫–æ–ø–∏—Ç','–ê–∫—Ü–∏–∏','–û–§–ó','–§–æ–Ω–¥—ã'];
    const pl = totalPL();

    const el1 = qS('#chartByClass');
    if (el1) {
      const ctx1 = el1.getContext('2d');
      if (charts.c1) charts.c1.destroy();
      const bg = [
        grad(ctx1,'rgba(67,97,238,.9)','rgba(67,97,238,.3)'),
        grad(ctx1,'rgba(127,240,249,.9)','rgba(127,240,249,.35)'),
        grad(ctx1,'rgba(247,37,133,.9)','rgba(247,37,133,.35)'),
        grad(ctx1,'rgba(6,214,160,.9)','rgba(6,214,160,.35)')
      ];
      charts.c1 = new Chart(ctx1, {
        type: 'doughnut',
        data: { labels: classLabels, datasets: [{ data: classValues, borderWidth: 0, hoverOffset: 8, cutout: '62%', backgroundColor: bg }] },
        options: {
          plugins: { legend: { display: false }, tooltip: { enabled:false } },
          onHover: (_, els) => { charts.c1.setActiveElements(els); charts.c1.update(); },
          animation: { duration: 900, easing: 'easeOutQuart' }
        },
        plugins: [donutCenter((chart) => {
          const active = chart.getActiveElements?.() || [];
          if (active.length) {
            const i = active[0].index; const val = classValues[i];
            const p = total > 0 ? (val / total * 100) : 0;
            return { title: classLabels[i], line1: `${fmt(val)} ‚ÇΩ`, line2: `${fmt(p)}%` };
          } else {
            const color = pl.abs >= 0 ? getComputedStyle(document.documentElement).getPropertyValue('--ok') : getComputedStyle(document.documentElement).getPropertyValue('--accent');
            return { title:'–í—Å–µ–≥–æ', line1:`${fmt(total)} ‚ÇΩ`, line2:`P/L: ${fmt(pl.abs)} ‚ÇΩ (${fmt(pl.pct)}%)`, line2Color: color };
          }
        })]
      });

      // –ö–ª–∏–∫ –ø–æ —Å–µ–∫—Ç–æ—Ä—É ‚Üí –æ—Ç–∫—Ä—ã—Ç—å –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é
      el1.addEventListener('click', (evt)=>{
        const points = charts.c1.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
        if(points.length){
          const idx = points[0].index;
          const map = {1:'#sec-stocks',2:'#sec-bonds',3:'#sec-funds',0:'#sec-savings'};
          const sel = map[idx]; if(sel) toggleCollapsible(sel, true, true);
        }
      });

      el1.addEventListener('mouseleave', () => { charts.c1.setActiveElements([]); charts.c1.update(); });
    }

    // Bars
    const items = [...(portfolio.stocks||[]), ...(portfolio.bonds||[]), ...(portfolio.funds||[])].filter(i => (i.quantity||0)>0);
    const labelsTickers = items.map(i=> displayLabel(i) || i.name);
    const values = items.map(i=>(i.currentPrice??i.avgPrice??0)*(i.quantity||0));
    const qtys   = items.map(i=>i.quantity||0);
    const trimLabel = s => (s||'').length>18 ? (s||'').slice(0,17)+'‚Ä¶' : (s||'');

    const barOpts = { plugins:{ legend:{ display:false } }, scales:{ x:{ grid:{ display:false }, ticks:{ maxRotation: 45, minRotation: 0, autoSkip:true, callback:(v,i)=> trimLabel(labelsTickers[i]) } }, y:{ ticks:{ callback:(v)=> fmt(v) }, grid:{ color:axisGrid } } }, animation:{duration:700} };

    const el2=qS('#chartByTickerValue');
    if(el2){ const ctx=el2.getContext('2d'); if(charts.v) charts.v.destroy(); charts.v=new Chart(ctx,{ type:'bar', data:{ labels: labelsTickers, datasets:[{ data:values, borderRadius:10, backgroundColor:(c)=>{const ctx=c.chart.ctx;return grad(ctx,'rgba(67,97,238,.9)','rgba(127,240,249,.4)')} }] }, options:barOpts }); }
    const el3=qS('#chartByTickerQty');
    if(el3){ const ctx=el3.getContext('2d'); if(charts.q) charts.q.destroy(); charts.q=new Chart(ctx,{ type:'bar', data:{ labels: labelsTickers, datasets:[{ data:qtys, borderRadius:10, backgroundColor:(c)=>{const ctx=c.chart.ctx;return grad(ctx,'rgba(6,214,160,.9)','rgba(67,97,238,.4)')} }] }, options:{...barOpts, scales:{ x:{ grid:{display:false}, ticks:{ maxRotation:45, minRotation:0, autoSkip:true, callback:(v,i)=> trimLabel(labelsTickers[i]) } }, y:{ ticks:{ callback:(v)=> fmt(v,0) }, grid:{ color:axisGrid } } } }); }
    removeSkeleton();
  }

  function makeLineChart(canvasId,label){
    const el = qS('#'+canvasId); if(!el) return null;
    const ctx = el.getContext('2d'); const g = ctx.createLinearGradient(0,0,0,300); g.addColorStop(0,'rgba(67,97,238,.35)'); g.addColorStop(1,'rgba(67,97,238,.02)');
    charts[canvasId] = new Chart(ctx,{ type:'line', data:{ labels:[], datasets:[{ label, data:[], borderWidth:2.2, fill:true, backgroundColor:g, borderColor:getComputedStyle(document.documentElement).getPropertyValue('--brand')||'#4361ee', pointRadius:0, tension:.25 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ x:{ grid:{ display:false }, ticks:{ maxRotation:0, autoSkip:true } }, y:{ grid:{ color:getComputedStyle(document.documentElement).getPropertyValue('--stroke')||'rgba(0,0,0,.1)' }, ticks:{ callback:(v)=> fmt(v) } } }, animation:{duration:600} }});
    return charts[canvasId];
  }

  function periodToBackend(period){
    const to=new Date(); const from=new Date(to); let interval='1d';
    if(period==='1D'){ interval='1min'; from.setDate(to.getDate()-1); }
    else if(period==='1W'){ interval='15min'; from.setDate(to.getDate()-7); }
    else if(period==='1M'){ interval='1h'; from.setDate(to.getDate()-30); }
    else if(period==='1Y'){ interval='1d'; from.setFullYear(to.getFullYear()-1); }
    return { interval, fromISO: from.toISOString(), toISO: to.toISOString() };
  }
  function formatXAxisLabel(period, isoString){
    const d=new Date(isoString);
    if(period==='1D'){ const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0'); return `${hh}:${mm}`; }
    if(period==='1W'||period==='1M'){ const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); return `${dd}.${mm}`; }
    const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=String(d.getFullYear()%100).padStart(2,'0'); return `${mm}.${yy}`;
  }
  async function updateAssetChartByFigi(canvasId, figi, label, period){
    let {interval, fromISO, toISO}=periodToBackend(period);
    let data=await apiCandles(figi, interval, fromISO, toISO);
    if((!data||data.length===0)&& (interval==='1min'||interval==='5min'||interval==='15min')){
      const fallback = interval==='15min'?'1h':(interval==='5min'?'15min':'5min');
      data = await apiCandles(figi, fallback, fromISO, toISO);
    }
    const ch=charts[canvasId]||makeLineChart(canvasId, label);
    ch.data.labels=(data||[]).map(x=> formatXAxisLabel(period, x.time));
    ch.data.datasets[0].data=(data||[]).map(x=> x.close); ch.update();
  }

  /* ====== QUOTES ====== */
  async function recalcQuotes(){
    if(isRefreshing) return; isRefreshing=true;
    const tickers=[...(portfolio.stocks||[]).map(i=>i.name), ...(portfolio.bonds||[]).map(i=>i.name), ...(portfolio.funds||[]).map(i=>i.name)];
    if(!tickers.length){ isRefreshing=false; return; }
    try{
      const results=await apiBatchQuotes(tickers);
      const map={}; results.forEach(q => { map[(q.ticker||'').toUpperCase()] = q; });
      for(const cat of ['stocks','bonds','funds']){
        for(const it of (portfolio[cat]||[])){
          const q=map[(it.name||'').toUpperCase()]; if(!q) continue;
          it.figi=q.figi; it.currency=q.currency; it.ticker=q.ticker;
          it.displayName=(q.name&&q.ticker)?`${q.name} (${q.ticker})`:(q.name||q.ticker||it.name);
          it.currentPrice=q.price; it.value=(it.currentPrice??it.avgPrice??0)*(it.quantity||0);
          it.pnlAbs=it.avgPrice ? (it.currentPrice - it.avgPrice) * (it.quantity||0) : 0;
          it.pnlPct=it.avgPrice ? ((it.currentPrice - it.avgPrice)/it.avgPrice*100) : 0;
        }
      }
      pushHistory();
      if(!isAnyChartOpen){ renderSummary(); renderSections(); renderCharts(); }
      saveLocal();
    }catch(err){ console.error(err); toast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ç–∏—Ä–æ–≤–æ–∫','err'); }
    finally{ isRefreshing=false; }
  }

  /* ====== ADD / EDIT / DELETE ====== */
  function ensureAuthGuard(){ if(!auth.token || !auth.userId){ toast('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –ë–î','err'); window.location.href='login.html'; return false; } return true; }

  async function addAsset(e){
    e.preventDefault();
    const type=qS('#assetType').value;
    let dateVal=qS('#assetDate').value||''; if(dateVal && dateVal.indexOf('-')<0){ const iso=toISOFromAlt(dateVal); if(iso) dateVal=iso; }
    const date = dateVal || new Date().toISOString().slice(0,10);

    if(type==='savings'){
      const amount=parseFloat(qS('#savingsAmount').value)||0; if(amount<=0){ toast('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å—á—ë—Ç–∞','err'); return; }
      portfolio.savings.push({ value: amount, date }); toast('–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ (–ª–æ–∫–∞–ª—å–Ω–æ)');
    } else {
      if(!ensureAuthGuard()) return;
      const name=(qS('#assetName').value||'').trim().toUpperCase();
      const qty=parseFloat(qS('#assetQuantity').value)||0;
      const avg=parseFloat(qS('#assetAvgPrice').value)||0;
      if(!name || qty<=0){ toast('–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ','err'); return; }
      const mapClass={ stock:'share', bond:'bond', fund:'etf' }; const classHint=mapClass[type]||null;
      try{
        const r=await apiResolve(name, classHint);
        const pfId=auth.portfolioId || (await apiCreatePortfolio()).id;
        const saved=await apiUpsertPositionByFigi({ portfolio_id:pfId, figi:r.figi, ticker:name, class_hint:classHint, qty, avg, name:r.name, currency:r.currency, nominal:r.nominal||null });
        const q=await apiResolveQuoteByTicker(name, classHint); const price=q.price||avg; const bucket=type+'s';
        const val=(price||0) * qty; const pnlAbs=avg ? (price-avg)*qty : 0; const pnlPct=avg ? ((price-avg)/avg*100) : 0;
        const displayName=(q.name&&q.ticker)?`${q.name} (${q.ticker})`:(q.name||q.ticker||name);
        portfolio[bucket].push({ posId:saved?.id||null, name, quantity:qty, avgPrice:avg, currentPrice:price, value:val, pnlAbs, pnlPct, date, figi:q.figi, currency:q.currency, class:q.class, ticker:q.ticker, displayName });
        toast('–ê–∫—Ç–∏–≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –ë–î');
      }catch(err){ console.error(err); toast(err?.response?.data?.detail || err?.message || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è', 'err'); return; }
    }

    renderSummary(); renderSections(); renderCharts(); pushHistory(); saveLocal();
    e.target.reset(); if(fp) fp.setDate(new Date()); onTypeChange();
    const btn=qS('#addBtn'); btn.classList.remove('rippling'); setTimeout(()=> btn.classList.add('rippling'), 0); setTimeout(()=> btn.classList.remove('rippling'), 250);
  }

  document.addEventListener('click', async (e)=>{
    const act = e.target.closest('[data-action]'); if(!act) return;
    const action = act.getAttribute('data-action');

    if(action==='del'){
      const type=act.getAttribute('data-type'); const idx=Number(act.getAttribute('data-index')); const it=(portfolio[type]||[])[idx]; if(!it) return;
      if(it.posId){ try { await apiDeletePosition(it.posId); } catch(err){ console.warn('delete failed', err); toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤ –ë–î','err'); return; } }
      (portfolio[type]||[]).splice(idx,1); renderSummary(); renderSections(); renderCharts(); saveLocal(); toast('–£–¥–∞–ª–µ–Ω–æ'); return;
    }

    if(action==='edit'){
      const type=act.getAttribute('data-type'); const idx=Number(act.getAttribute('data-index')); const it=(portfolio[type]||[])[idx]; if(!it) return;
      const q = prompt(`–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è ${displayLabel(it)}:`, it.quantity); if(q===null) return;
      const a = prompt(`–ù–æ–≤–∞—è —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ (‚ÇΩ –∑–∞ 1 —à—Ç.) –¥–ª—è ${displayLabel(it)}:`, it.avgPrice||0); if(a===null) return;
      it.quantity=parseFloat(q)||0; it.avgPrice=parseFloat(a)||0;
      if(it.figi){ try{ const saved=await apiUpsertPositionByFigi({ portfolio_id:auth.portfolioId, figi:it.figi, ticker:it.ticker||it.name, class_hint:it.class||null, qty:it.quantity, avg:it.avgPrice, name:it.displayName, currency:it.currency, nominal:it.nominal }); if(saved?.id) it.posId=saved.id; }catch(err){ console.warn('upsert failed', err); toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î','err'); } }
      await recalcQuotes(); toast('–ò–∑–º–µ–Ω–µ–Ω–æ'); return;
    }

    if(action==='show'){
      const name=act.getAttribute('data-name'); const id=cssId(name); const box=qS(`#box-${id}`); if(!box) return;
      const it=[...(portfolio.stocks||[]), ...(portfolio.bonds||[]), ...(portfolio.funds||[])].find(x=>x.name===name);
      const figi=it?.figi; const canvasId=`canvas-${id}`;
      const visible = box.style.display!=='none';
      qSA('[id^="box-"]').forEach(b=> b.style.display='none'); // –æ–¥–∏–Ω –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
      if(visible){ box.style.display='none'; isAnyChartOpen=false; return; }
      box.style.display='block'; isAnyChartOpen=true;
      if(charts[canvasId] && charts[canvasId].canvas !== qS('#'+canvasId)){ try{ charts[canvasId].destroy(); }catch(_){ } delete charts[canvasId]; }
      if(!charts[canvasId]){ makeLineChart(canvasId, displayLabel(it) || it?.name || name); }
      if(figi){ await updateAssetChartByFigi(canvasId, figi, displayLabel(it) || it?.name || name, '1D'); } else { toast('–ù–µ—Ç FIGI –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ ‚Äî –æ–±–Ω–æ–≤–∏ –∫–æ—Ç–∏—Ä–æ–≤–∫–∏','err'); }
      setTimeout(()=>{ box.scrollIntoView({behavior:'smooth', block:'nearest'}); }, 50);
      return;
    }

    if(action==='period'){
      const id=act.getAttribute('data-for'); const card=act.closest('.asset'); const name=card?.querySelector('[data-action="show"]')?.getAttribute('data-name');
      card.querySelectorAll('.chart-tab').forEach(t=>t.classList.remove('btn-primary')); act.classList.add('btn-primary');
      const it=[...(portfolio.stocks||[]), ...(portfolio.bonds||[]), ...(portfolio.funds||[])].find(x=>x.name===name);
      if(it?.figi){ await updateAssetChartByFigi(`canvas-${id}`, it.figi, displayLabel(it) || it?.name || name, act.getAttribute('data-period')); } else { toast('–ù–µ—Ç FIGI –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ ‚Äî –æ–±–Ω–æ–≤–∏ –∫–æ—Ç–∏—Ä–æ–≤–∫–∏','err'); }
      return;
    }
  });

  function onTypeChange(){
    const t=qS('#assetType').value; const isSavings=t==='savings';
    qS('#fieldName').style.display=isSavings?'none':''; qS('#fieldQuantity').style.display=isSavings?'none':''; qS('#fieldPrice').style.display=isSavings?'none':'';
    qS('#fieldSavingsAmount').style.display=isSavings?'':'none';
    qS('#assetName').required = !isSavings; qS('#assetQuantity').required=!isSavings; qS('#assetAvgPrice').required=false; qS('#savingsAmount').required=isSavings;
  }

  /* ====== INIT ====== */
  async function hardRefresh(){ await recalcQuotes(); }

  document.addEventListener('DOMContentLoaded', async ()=>{
    initTheme();
    qS('#themeToggle').addEventListener('click', (e)=>{ const rect=e.currentTarget.getBoundingClientRect(); const x=((e.clientX-rect.left)/rect.width*100).toFixed(2)+"%"; const y=((e.clientY-rect.top)/rect.height*100).toFixed(2)+"%"; e.currentTarget.style.setProperty('--rx',x); e.currentTarget.style.setProperty('--ry',y); e.currentTarget.classList.remove('rippling'); setTimeout(()=> e.currentTarget.classList.add('rippling'), 0); setTimeout(()=> e.currentTarget.classList.remove('rippling'), 250); const cur=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'; setTheme(cur); });

    initDatePicker(); loadTitle();
    qS('#editTitleBtn').addEventListener('click', ()=>{ const cur=qS('#portfolioTitle').textContent.trim(); const v=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—è', cur); if(v!==null && v.trim()){ localStorage.setItem('pf_title', v.trim()); applyTitle(v.trim()); toast('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ'); } });

    loadAuth(); loadLocal();
    qS('#logoutBtn').addEventListener('click', ()=>{ clearAuth(); toast('–í—ã –≤—ã—à–ª–∏'); window.location.href='login.html'; });

    qS('#assetForm').addEventListener('submit', addAsset);
    qS('#assetType').addEventListener('change', onTypeChange); onTypeChange();

    try{ await loadFromDB(); }catch(e){ console.warn('loadFromDB failed', e); toast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—å –∏–∑ –ë–î','err'); }

    renderSummary(); renderSections(); renderCharts();
    qS('#refreshBtn').addEventListener('click', hardRefresh);
    await hardRefresh();
    if(quotesTimer) clearInterval(quotesTimer); quotesTimer=setInterval(hardRefresh, 30*1000);
  });
</script>
</body>
</html>
