<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="pageTitle">Инвестиции</title>

  <script>
    if (!localStorage.getItem('pf_token')) {
      window.location.replace('login.html');
    }
    // Initialize theme
    document.documentElement.setAttribute('data-theme', localStorage.getItem('pf_theme') || 'dark');
  </script>

  <!-- Critical CSS - загружается сразу -->
  <link rel="stylesheet" href="assets/css/critical.css" />
  
  <!-- Non-critical resources - загружаются асинхронно -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"></noscript>
  
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.2/dist/axios.min.js"></script>
  
  <!-- Chart.js загружается сразу для корректной работы -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  
  <!-- Flatpickr загружается асинхронно -->
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"></noscript>
  
  <script>
    window.loadFlatpickr = function() {
      return new Promise((resolve) => {
        if (window.flatpickr) { resolve(); return; }
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/flatpickr';
        script.onload = () => {
          const ruScript = document.createElement('script');
          ruScript.src = 'https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js';
          ruScript.onload = resolve;
          document.head.appendChild(ruScript);
        };
        document.head.appendChild(script);
      });
    };
  </script>
  
  <link rel="preload" href="assets/css/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="assets/css/style.css"></noscript>

  <!-- Мобильные оптимизации -->
  <meta name="theme-color" content="#4361ee">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
</head>
<body>
  <div class="aurora"></div>
  <div class="blob one"></div>
  <div class="blob two"></div>

  <div class="container">
    <header>
      <div class="search-wrap">
        <input id="searchInput" type="text" placeholder="Поиск по тикерам/названию…" title="Искать по тикеру и названию (/)"/>
      </div>

      <div class="header-actions">
        <button class="btn btn-ghost" id="toggleAllBtn" title="Свернуть/развернуть все секции (S)">
          <span class="icon icon-compact"></span>
          Все
        </button>
        <div id="authStatus" class="auth-status">Гость</div>
        <button id="logoutBtn" class="btn btn-danger" title="Выйти">
          <span class="icon icon-logout"></span>
          Выйти
        </button>
        <button id="refreshBtn" class="btn" title="Обновить котировки (R)">
          <span class="icon icon-refresh"></span>
          Обновить
        </button>
        <button id="themeToggle" class="btn" title="Сменить тему (T)">
          <span class="icon icon-theme"></span>
          Тема
        </button>
        <button id="apiStatusBtn" class="btn" title="Подключение Tinkoff Invest API">
          <span class="icon icon-compact"></span>
          <span id="apiStatusDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#888;margin-left:6px;"></span>
        </button>
        <button id="helpBtn" class="btn" title="Справка (?)">
          <span class="icon icon-help"></span>
          Справка
        </button>
      </div>
    </header>

    <!-- Табы -->
    <nav class="tabs-row">
      <a class="tab active" href="index.html">Инвестиции</a>
      <a class="tab" href="budget.html">Бюджетирование</a>
      <a class="tab" href="obligations.html">Обязательства</a>
    </nav>

    <div class="portfolio-charts">
      <div class="chart-card animate-in skeleton" id="sk1"><h3>Аллокация по классам</h3><canvas id="chartByClass"></canvas></div>
      <div class="chart-card animate-in skeleton" id="sk2"><h3>Аллокация по тикерам (стоимость)</h3><canvas id="chartByTickerValue"></canvas></div>
      <div class="chart-card animate-in skeleton" id="sk3"><h3>Количество бумаг по тикерам</h3><canvas id="chartByTickerQty"></canvas></div>
    </div>

    <h2 class="zone-title">Итоги</h2>
    <div class="portfolio-summary" id="portfolioSummary">
      <!-- Плашка доходности будет добавлена динамически -->
    </div>

    <div class="title-row">
      <h2 class="zone-title">Позиции</h2>
      <button id="openAddBtn" class="btn btn-primary" title="Добавить актив (A)">
        <span class="icon icon-add"></span>
        Добавить актив
      </button>
    </div>

    <!-- Нулевое состояние -->
    <div id="emptyState" class="empty-state hidden">
      <div class="empty-card">
        <h3>Как начать</h3>
        <ol class="muted">
          <li>Нажмите <b>«Добавить актив»</b> и внесите первую сделку.</li>
          <li>Нажмите <b>«Обновить»</b> — подтянем FIGI и котировки, появятся графики.</li>
          <li>Используйте <b>поиск</b> и <b>сворачивание секций</b> для навигации.</li>
        </ol>
        <div class="empty-actions">
          <button class="btn btn-primary" id="emptyAddBtn">
            <span class="icon icon-add"></span>
            Добавить актив
          </button>
          <button class="btn" id="helpOpenSecondary">Показать справку</button>
        </div>
      </div>
    </div>

    <div id="portfolioSections"></div>
  </div>

  <!-- Toasts -->
  <div class="toast-wrap" id="toastWrap"></div>

  <!-- FAB (мобилка) -->
  <button id="fabAddBtn" class="fab" title="Добавить актив (A)">
    <span class="icon icon-add"></span>
  </button>

  <!-- Кнопка компактного режима -->
  <button id="compactToggle" title="Компактный режим">
    <span class="icon icon-compact"></span>
  </button>

  <!-- Модалка: ДОБАВИТЬ АКТИВ -->
  <div id="addModal" class="modal" aria-hidden="true">
    <div class="modal__dialog">
      <div class="modal__header">
        <h3>Добавить актив</h3>
        <button class="modal__close" id="addCloseX" aria-label="Закрыть">
          <span class="icon icon-close"></span>
        </button>
      </div>

      <form id="assetForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="assetType">Тип актива</label>
            <div class="select-wrap">
              <select id="assetType" required>
                <option value="" disabled selected>Выберите тип</option>
                <option value="stock">Акция</option>
                <option value="bond">ОФЗ/Облигация</option>
                <option value="fund">Фонд/ETF</option>
              </select>
            </div>
          </div>

          <div class="form-group" id="fieldName">
            <label for="assetName">Тикер / Название</label>
            <input type="text" id="assetName" placeholder="SBER, YNDX, TGLD" />
          </div>

          <div class="form-group" id="fieldQuantity">
            <label for="assetQuantity">Количество</label>
            <input type="number" id="assetQuantity" min="0" step="1" placeholder="Напр.: 10" />
          </div>

          <div class="form-group" id="fieldPrice">
            <label for="assetAvgPrice">Цена покупки (₽)</label>
            <input type="number" id="assetAvgPrice" step="0.0001" min="0" placeholder="Напр.: 4383" />
          </div>

          <div class="form-group" id="fieldDate">
            <label for="assetDate">Дата покупки</label>
            <input type="text" id="assetDate" placeholder="дд.мм.гггг" />
          </div>
        </div>

        <div class="modal__footer">
          <button id="addCloseBtn" type="button" class="btn btn-ghost">Отмена</button>
          <button type="submit" class="btn btn-primary" id="addBtn">Добавить</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Модалка: ИЗМЕНИТЬ -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="modal__dialog">
      <div class="modal__header">
        <h3 id="editTitle">Изменить позицию</h3>
        <button class="modal__close" id="editCancelX" aria-label="Закрыть">✕</button>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>FIGI</label>
          <div id="editFigi" class="readonly-box">—</div>
        </div>
        <div class="form-group">
          <label for="editDeltaQty">Количество (Δ)</label>
          <input id="editDeltaQty" type="number" placeholder="+/- шт. (покупка = +, продажа = -)" />
        </div>
        <div class="form-group">
          <label for="editPrice">Цена сделки</label>
          <input id="editPrice" type="number" step="0.0001" placeholder="Цена за 1 шт." />
        </div>
        <div class="form-group">
          <label for="editDate">Дата сделки</label>
          <input id="editDate" type="text" placeholder="дд.мм.гггг" />
        </div>
      </div>
      <div class="modal__footer">
        <button id="editCancelBtn" class="btn btn-ghost">Отмена</button>
        <button id="editSaveBtn" class="btn btn-primary">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Модалка: ТОКЕН -->
  <div id="tokenModal" class="modal" aria-hidden="true">
    <div class="modal__dialog">
      <div class="modal__header">
        <h3>Токен Тинькофф</h3>
        <button class="modal__close" id="modalCancelX" aria-label="Закрыть">✕</button>
      </div>
      <p class="muted">Токен хранится на сервере в зашифрованном виде. Изменение токена повлияет на доступ к данным рынка.</p>
      <label for="modalTinkoffToken">Новый токен</label>
      <input id="modalTinkoffToken" type="password" placeholder="t.xxxxx" />
      <div class="modal__footer">
        <button id="modalCancelBtn" class="btn btn-ghost">Отмена</button>
        <button id="modalClearBtn" class="btn btn-danger">Очистить</button>
        <button id="modalSaveBtn" class="btn btn-primary">Сохранить</button>
      </div>
    </div>
  </div>

  <!-- Модалка: СПРАВКА -->
  <div id="helpModal" class="modal" aria-hidden="true">
    <div class="modal__dialog">
      <div class="modal__header">
        <h3>Справка и горячие клавиши</h3>
        <button class="modal__close" id="helpCloseX" aria-label="Закрыть">✕</button>
      </div>
      <div class="modal__body">
        <ul class="help-list">
          <li><b>Поиск</b> — по тикеру и названию. Клавиша <span class="kbd">/</span>.</li>
          <li><b>Все</b> — свернуть/развернуть секции. Клавиша <span class="kbd">S</span>.</li>
          <li><b>Обновить</b> — подтянуть котировки и FIGI. Клавиша <span class="kbd">R</span>.</li>
          <li><b>Тема</b> — тёмная/светлая. Клавиша <span class="kbd">T</span>.</li>
          <li><b>Добавить актив</b> — модалка ввода сделки. Клавиша <span class="kbd">A</span>.</li>
          <li><b>API Тинькофф</b> — индикатор подключения. Нажмите, чтобы изменить токен.</li>
        </ul>
      </div>
      <div class="modal__footer">
        <button id="helpCloseBtn" class="btn btn-primary">Понятно</button>
      </div>
    </div>
  </div>

  <script src="assets/js/network-optimizer.js"></script>
  <script defer src="assets/js/script.js"></script>
</body>
</html>
